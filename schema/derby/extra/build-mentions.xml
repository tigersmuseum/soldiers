<?xml version="1.0"?>

<project name="Soldiers Database" default="mentions" basedir=".">

	<description>
		Relating soldiers to sources.
	</description>

	<property file="../ant.properties"/>

	<path id="derby.path">
		<pathelement location="${DERBY_HOME}/lib/derby.jar"/>
		<pathelement location="${DERBY_HOME}/lib/derbyclient.jar"/>
	</path>


	<target name="mentions">
		<sql src="mentions.sql" driver="${driver}" url="${jdbc}" userid="${userid}" password="${password}" print="true" onerror="continue">	
			<classpath refid="derby.path"/>
		</sql>		
	</target>
			
	<target name="import-sources">
		<sql driver="${driver}" url="${jdbc}" userid="${userid}" password="${password}" print="true" onerror="continue">	
		<![CDATA[
		CALL SYSCS_UTIL.SYSCS_IMPORT_DATA
		(NULL, 'SOURCES', 'KEY,LABEL,SOURCE_REF,FILE', null, '${data-local}/sources.csv', null, null, null, 0)
		]]>
		<classpath refid="derby.path"/>
		</sql>		
	</target>
	
	<target name="import-mentions">
	<sql driver="${driver}" url="${jdbc}" userid="${userid}" password="${password}" print="true" onerror="continue">	
	<![CDATA[
	CALL SYSCS_UTIL.SYSCS_IMPORT_DATA
	(NULL, 'MENTIONS', 'SOURCE,SID,ITEM_REF', null, 'mention.csv', null, null, null, 0)
	]]>
	<classpath refid="derby.path"/>
	</sql>		
	</target>
	
	<target name="import-mentions-2">
	<!--
		In case the same source mentions a specific soldier more than once ...
		Import the mentions into a temporary table, then 'select distint into' MENTIONS
	-->
	<sql driver="${driver}" url="${jdbc}" userid="${userid}" password="${password}" print="true" onerror="continue">	
	<![CDATA[
	CALL SYSCS_UTIL.SYSCS_IMPORT_DATA
	(NULL, 'MENTIONS', 'SOURCE,SID,ITEM_REF', null, 'mention.csv', null, null, null, 0)
	]]>
	<classpath refid="derby.path"/>
	</sql>		
	</target>
		
	<target name="scratch">
		<echo>${jdbc}</echo>
		<sql driver="${driver}" url="${jdbc}" userid="${userid}" password="${password}" print="true" onerror="continue">	
		<![CDATA[

		select * from SOURCES
			
		 --select * from MENTIONS where SID in (170072, 104022, 191266, 186975)
			
		-- select distinct SOURCE from MENTIONS

		]]>		
	 	<classpath refid="derby.path"/>
		</sql>		
	</target>
	
	<target name="duplicates">
		<!--
		FInd where there is more than one entry with the same surname and service number
		-->
		<echo>${jdbc}</echo>
		<sql driver="${driver}" url="${jdbc}" userid="${userid}" password="${password}" print="true" onerror="continue">	
		<![CDATA[
		select P1.SURNAME, P1.INITIALS, S1.NUM, P2.SURNAME, P2.INITIALS, S2.NUM from SERVICE as S1, SERVICE as S2, PERSON as P1, PERSON as P2
			where S1.NUM != '' and S2.NUM != '' and S1.NUM = S2.NUM and S1.SID != S2.SID
			and S1.SID = P1.SID and S2.SID = P2.SID
			and P1.SID < P2.SID
			and P1.SURNAME = P2.SURNAME
		]]>		
	 	<classpath refid="derby.path"/>
		</sql>		
	</target>
	
</project>
